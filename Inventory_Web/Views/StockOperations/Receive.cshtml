@model Inventory_Web.Controllers.ReceiveStockViewModel
@{
    ViewData["Title"] = "ورود کالا به انبار";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var products = ViewBag.Products as List<Inventory_Web.Controllers.StockProductInfo> ?? new List<Inventory_Web.Controllers.StockProductInfo>();
    var warehouses = ViewBag.Warehouses as List<Inventory_Web.Controllers.StockWarehouseInfo> ?? new List<Inventory_Web.Controllers.StockWarehouseInfo>();
}

<div class="card">
    <div class="card-header">
        <h3 class="card-title">ورود کالا به انبار</h3>
    </div>
    <div class="card-body">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                @TempData["Error"]
            </div>
        }

        <form asp-action="Receive" method="post" id="receiveForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="ProductId" class="form-label">کالا *</label>
                        <select asp-for="ProductId" class="form-control select2-search" id="productSelect" required>
                            <option value="">-- انتخاب کالا --</option>
                            @foreach (var product in products)
                            {
                                <option value="@product.Id" data-code="@product.MainCode">@product.Name - @product.MainCode</option>
                            }
                        </select>
                        <span asp-validation-for="ProductId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="WarehouseId" class="form-label">انبار *</label>
                        <select asp-for="WarehouseId" class="form-control" required>
                            <option value="">-- انتخاب انبار --</option>
                            @foreach (var warehouse in warehouses)
                            {
                                <option value="@warehouse.Id">@warehouse.Name</option>
                            }
                        </select>
                        <span asp-validation-for="WarehouseId" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label asp-for="BrandId" class="form-label">برند *</label>
                        <select asp-for="BrandId" class="form-control" id="brandSelect" required disabled>
                            <option value="">-- ابتدا کالا را انتخاب کنید --</option>
                        </select>
                        <span asp-validation-for="BrandId" class="text-danger"></span>
                        <small class="text-muted" id="brandHelp">برندهای مرتبط با کالا انتخاب شده نمایش داده می‌شوند</small>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="Quantity" class="form-label">تعداد *</label>
                        <input asp-for="Quantity" type="number" class="form-control" min="1" required />
                        <span asp-validation-for="Quantity" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label asp-for="Reason" class="form-label">دلیل ورود</label>
                        <input asp-for="Reason" class="form-control" placeholder="علت ورود کالا به انبار" />
                        <span asp-validation-for="Reason" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-sign-in-alt"></i> ثبت ورود کالا
                </button>
                <a href="@Url.Action("Index")" class="btn btn-secondary">
                    <i class="fas fa-arrow-right"></i> بازگشت
                </a>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 6px 12px;
        }

            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 36px;
            }
    </style>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/i18n/fa.min.js"></script>

    <script>
        $(document).ready(function () {
            // راه‌اندازی Select2 برای dropdown کالاها
            $('#productSelect').select2({
                placeholder: "جستجو و انتخاب کالا...",
                allowClear: true,
                language: "fa",
                width: '100%',
                matcher: function (params, data) {
                    // اگر عبارت جستجو خالی است، همه موارد را نشان بده
                    if ($.trim(params.term) === '') {
                        return data;
                    }

                    // جستجو هم در نام کالا و هم در کد اصلی
                    var term = params.term.toLowerCase();
                    var productName = data.text ? data.text.toLowerCase() : '';

                    // دریافت کد محصول و اطمینان از اینکه رشته است
                    var productCodeData = $(data.element).data('code');
                    var productCode = '';
                    if (productCodeData) {
                        productCode = productCodeData.toString().toLowerCase();
                    }

                    if (productName.indexOf(term) > -1 || productCode.indexOf(term) > -1) {
                        return data;
                    }

                    return null;
                },
                templateResult: function (data) {
                    if (!data.id) {
                        return data.text;
                    }

                    // دریافت کد محصول و اطمینان از نمایش صحیح
                    var productCodeData = $(data.element).data('code');
                    var displayCode = '---';
                    if (productCodeData) {
                        displayCode = productCodeData.toString();
                    }

                    var $result = $(
                        '<div>' +
                        '<span>' + data.text + '</span>' +
                        '<small style="display: block; color: #6c757d; font-size: 0.875em;">کد: ' + displayCode + '</small>' +
                        '</div>'
                    );
                    return $result;
                },
                templateSelection: function (data) {
                    // نمایش مختصر در حالت انتخاب شده
                    if (!data.id) {
                        return data.text;
                    }
                    return data.text;
                }
            });

            const productSelect = $('#productSelect');
            const brandSelect = $('#brandSelect');
            const brandHelp = $('#brandHelp');

            // وقتی کالا تغییر می‌کند
            productSelect.on('change', function () {
                const productId = $(this).val();

                if (productId) {
                    // غیرفعال کردن dropdown برندها در حین لود
                    brandSelect.prop('disabled', true).html('<option value="">در حال بارگذاری برندها...</option>');
                    brandHelp.text('در حال دریافت برندهای مرتبط...');

                    // دریافت برندهای مرتبط با کالا
                    $.get(`/api/ProductBrands/product/${productId}`, function (brands) {
                        if (brands && brands.length > 0) {
                            brandSelect.html('<option value="">-- انتخاب برند --</option>');
                            brands.forEach(function (brand) {
                                brandSelect.append(`<option value="${brand.brandId}">${brand.brandName}</option>`);
                            });
                            brandSelect.prop('disabled', false);
                            brandHelp.text(`تعداد ${brands.length} برند مرتبط یافت شد`);
                        } else {
                            brandSelect.html('<option value="">-- هیچ برندی برای این کالا تعریف نشده --</option>');
                            brandSelect.prop('disabled', true);
                            brandHelp.text('⚠️ هیچ برندی برای این کالا تعریف نشده است. لطفاً از صفحه مدیریت کالا، برندها را اضافه کنید.');
                        }
                    }).fail(function (xhr, status, error) {
                        console.error('خطا در دریافت برندها:', error);
                        brandSelect.html('<option value="">-- خطا در دریافت برندها --</option>');
                        brandHelp.text('❌ خطا در دریافت برندهای کالا');
                    });
                } else {
                    // اگر کالای انتخاب نشده
                    brandSelect.html('<option value="">-- ابتدا کالا را انتخاب کنید --</option>');
                    brandSelect.prop('disabled', true);
                    brandHelp.text('برندهای مرتبط با کالا انتخاب شده نمایش داده می‌شوند');
                }
            });

            // مدیریت ارسال فرم - بررسی انتخاب برند
            $('#receiveForm').submit(function (e) {
                const productId = productSelect.val();
                const brandId = brandSelect.val();

                if (productId && (!brandId || brandSelect.prop('disabled'))) {
                    e.preventDefault();
                    alert('⚠️ لطفاً یک برند معتبر انتخاب کنید. اگر برندی موجود نیست، ابتدا از صفحه مدیریت کالا، برندها را اضافه کنید.');
                    return false;
                }
            });
        });
    </script>
}